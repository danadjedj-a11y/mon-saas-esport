# üöÄ Guide de Finalisation Migration : Supabase vers Convex

Ce document d√©taille **pr√©cis√©ment** ce qui reste √† faire pour terminer la migration de l'application, en particulier pour le composant critique [Tournament.jsx](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/Tournament.jsx).

> **√âtat actuel** : L'infrastructure Core, Auth, Profils, √âquipes, Dashboard Joueur/Organisateur, et Cr√©ation de Tournoi sont **100% migr√©s**.
> Le fichier [Tournament.jsx](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/Tournament.jsx) est migr√© √† **60%** (Imports, Hooks, StartTournament, GenerateBracket, RemoveParticipant, CheckIn sont faits).

---

## üìÖ Reste √† faire sur [src/Tournament.jsx](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/Tournament.jsx)

Le fichier a d√©j√† les imports Convex et les hooks `useMutation` d√©finis. Il reste √† remplacer les appels `supabase.from(...)` dans les fonctions de logique de jeu suivantes :

### 1. [saveScore](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/Tournament.jsx#683-744) (Ligne ~658)
Cette fonction g√®re la validation d'un score et la progression.
- **Action** : Remplacer `supabase.from('matches').update(...)` par `updateMatchScore`.
- **Action** : Remplacer `supabase.from('matches').select(...)` pour r√©cup√©rer le match mis √† jour par un appel √† la query `api.matches.getById` ou en utilisant le retour de la mutation si adapt√©.
- **Progression** : La logique de progression (Single/Double Elimination) fait des appels directs. Migrer vers `api.matchesMutations.progressWinner` (√† v√©rifier/cr√©er si la logique est complexe c√¥t√© client, voir point 2).

### 2. [handleDoubleEliminationProgression](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/Tournament.jsx#745-815) (Ligne ~720)
Cette fonction contient une logique complexe de mise √† jour de plusieurs matchs (Winners bracket -> Losers bracket).
- **Consigne CRITIQUE** : Ne pas essayer de reproduire cette logique complexe avec 15 appels `mutation` s√©par√©s c√¥t√© client.
- **Solution recommand√©e** : D√©placer toute cette logique dans une **nouvelle mutation Convex** `api.matchesMutations.handleProgression` qui prend le `matchId` et le `winnerId`.
    - Cette mutation devra encapsuler la logique de "Si Winner Bracket -> Move to next winner & Drop to loser" et "Si Loser Bracket -> Move to next loser".
    - Cela rendra le client beaucoup plus l√©ger et la transaction atomique.

### 3. [exportToPDF](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/Tournament.jsx#528-597) (Ligne ~503)
- **Action** : Cette fonction utilise les donn√©es locales (`participants`, `matches`) qui viennent d√©j√† du hook [useTournament](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/hooks/useConvex.js#59-73).
- **V√©rification** : S'assurer que les donn√©es structur√©es correspondent √† ce qu'attend `exportTournamentToPDF`. Normalement OK car [useTournament](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/hooks/useConvex.js#59-73) retourne les m√™mes structures.

### 4. [generateNextSwissRound](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/Tournament.jsx#598-661) (Ligne ~574)
- **Action** : Remplacer `supabase.from('matches').select` par `useQuery` (d√©j√† charg√© dans `matches`) ou une action serveur.
- **Action** : Remplacer `supabase.from('matches').insert` par `api.matchesMutations.batchCreate`.
- **Action** : Remplacer `getSwissScores` (qui appelle supabase) par `api.swiss.getScores`.

---

## üß© Composants Enfants √† V√©rifier

Ces composants sont import√©s dans [Tournament.jsx](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/Tournament.jsx) et contiennent probablement encore du code Supabase :

1.  **[src/TeamJoinButton.jsx](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/TeamJoinButton.jsx)**
    - Doit utiliser `api.tournamentRegistrationsMutations.register`.
2.  **[src/CheckInButton.jsx](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/CheckInButton.jsx)**
    - Doit utiliser `api.tournamentRegistrationsMutations.toggleCheckIn`.
3.  **[src/AdminPanel.jsx](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/AdminPanel.jsx)**
    - V√©rifier s'il fait des appels directs pour g√©rer les matchs/scores.
4.  **[src/SeedingModal.jsx](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/SeedingModal.jsx)**
    - Doit utiliser `api.tournamentRegistrationsMutations.updateSeed`.
5.  **[src/SchedulingModal.jsx](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/SchedulingModal.jsx)**
    - Doit utiliser une mutation pour update `scheduledTime`.

---

## üõ†Ô∏è Mapping des APIs Convex Disponibles

Voici les mutations d√©j√† cr√©√©es et pr√™tes √† l'emploi (dans `convex/_generated/api`) :

| Fonction Supabase Frontend | Mutation Convex Correspondante | Fichier |
|----------------------------|--------------------------------|---------|
| `matches.insert` (batch) | `api.matchesMutations.batchCreate` | [matchesMutations.ts](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/convex/matchesMutations.ts) |
| `matches.delete` (all) | `api.matchesMutations.deleteAllByTournament` | [matchesMutations.ts](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/convex/matchesMutations.ts) |
| `matches.update` (score) | `api.matchesMutations.updateScore` | [matchesMutations.ts](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/convex/matchesMutations.ts) |
| `matches.update` (teams) | `api.matchesMutations.updateTeams` | [matchesMutations.ts](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/convex/matchesMutations.ts) |
| `matches.insert` (game) | `api.matchesMutations.createGame` | [matchesMutations.ts](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/convex/matchesMutations.ts) |
| `participants.delete` | `api.tournamentRegistrationsMutations.removeParticipant` | [tournamentRegistrationsMutations.ts](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/convex/tournamentRegistrationsMutations.ts) |
| `participants.update` (checkin)| `api.tournamentRegistrationsMutations.toggleCheckIn` | [tournamentRegistrationsMutations.ts](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/convex/tournamentRegistrationsMutations.ts) |
| `participants.update` (seed) | `api.tournamentRegistrationsMutations.updateSeed` | [tournamentRegistrationsMutations.ts](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/convex/tournamentRegistrationsMutations.ts) |
| `tournaments.update` (status)| `api.tournamentsMutations.updateStatus` | [tournamentsMutations.ts](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/convex/tournamentsMutations.ts) |

---

## ‚ö†Ô∏è Points d'Attention (Mappings Sch√©ma)

Le sch√©ma Convex diff√®re l√©g√®rement de l'ancien sch√©ma Supabase :

- **Supabase** `round_number` ‚û°Ô∏è **Convex** `round`
- **Supabase** `bracket_type` ‚û°Ô∏è **Convex** `isLosersBracket` (boolean)
- **Supabase** `owner_id` ‚û°Ô∏è **Convex** `organizerId`
- **Supabase** `seed_order` ‚û°Ô∏è **Convex** `seed`
- **Supabase** `checked_in` (bool) ‚û°Ô∏è **Convex** `status: "checked_in"` (enum)

---

## üèÅ Finalisation

1.  Terminer le remplacement dans [Tournament.jsx](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/Tournament.jsx).
2.  Migrer les composants enfants list√©s ci-dessus.
3.  Supprimer le fichier [src/supabaseClient.js](file:///c:/Users/Dan/Documents/Fluky%20Boys/site/mon-tournoi/src/supabaseClient.js).
4.  D√©sinstaller `@supabase/supabase-js`.
5.  Faire un `npm run build` final pour valider.
